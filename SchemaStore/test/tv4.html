<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Schema test</title>
	<link href="../css/site.css" rel="stylesheet" />
	<style>
		ul {
			list-style: none;
		}

		ul > li:first-child{
			font-weight: bold;
			margin-top: 1em;
			margin-left: -1em;
		}

		span {
			display: block;
			margin: 0 0 0 1em;
			font-size: .8em;
			color: black;
		}

		.true {
			color: green;
		}

		.false {
			color: red;
		}
	</style>
</head>
<body>

	<header>
		<h1>Test runner</h1>
	</header>

	<div id="main">
		<ul id="result"></ul>
	</div>

	<script src="http://geraintluff.github.io/tv4/tv4.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.js"></script>
	<script>
		$.ajaxSetup({ cache: false });

		var list = document.getElementById("result");
		var results = [];

		function runTest(name, files) {

			var schemaUrl = "../schemas/json/" + name + ".json";

			$.getJSON(schemaUrl, null, function (schema) {

				for (var i = 0; i < files.length; i++) {

					$.getJSON("/" + files[i], null, function (file) {
						var result = tv4.validateMultiple(file, schema, true);
						result.url = cleanUrl(this.url);
						result.name = name;
						results.push(result);
					});
				}
			});
		}

		function cleanUrl(url) {

			if (url.indexOf("/test/") === 0)
				url = url.substring(6);

			var index = url.indexOf("?");

			if (index > -1) {
				return url.substring(0, index);
			}

			return url;
		}

		$(document).ajaxStop(function () {

			results = results.sort()
			list.innerHTML = "";

			var last = "";
			var ul = null;

			for (var i = 0; i < results.length; i++) {
				var result = results[i];

				if (result.name != last) {
					ul = document.createElement("ul");
					var cat = document.createElement("li");
					cat.innerHTML = result.name;
					ul.appendChild(cat);
					list.appendChild(ul);
				}

				last = result.name;
				
				var li = document.createElement("li");
				li.innerHTML = result.url;
				li.className = result.valid;

				if (!result.valid) {
					var error = result.errors.join("<br />");
					var msg = document.createElement("span");
					msg.innerHTML = error;
					li.appendChild(msg);
				}

				ul.appendChild(li);
			}
		});

		$.getJSON("tests.json", null, function (data) {

			list.innerHTML = "Running " + (Object.keys(data).length) + " tests..."

			for (var test in data) {
				if (test === "catalog" || test == "schemas")
					continue;

				var name = test.replace("_", ".");
				var files = data[test].src;
				runTest(name, files);
			}
		});
	</script>
</body>
</html>